
+ Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised host's private internal network.

+ After gaining access to one host, we can use the compromised host to exploit other hosts on the same internal network to which we could not access previously.

+ Meterpreter provides us with the ability to add a network route to the internal network's subnet and consequently scan and exploit other systems on the network.

![image](https://github.com/B4PHOM3T/eJPT-Notes/assets/89618500/4c4b9d0f-20a8-4d0a-a80c-4ebcb0cb0cfd)


### How to pivot ?

1. We can first try and ping the first and second victim machines. One of them should be inaccessible and we shouldn't be able to ping it as it is part of the internal network and isn't facing the internet. 

2. We will gain access to the target system which is accessible to us, which in our case is Victim 1.

3. After gaining access to victim 1, we can use `ipconfig` inside `shell` in the target machine to check the various interfaces available. In our case, both the victim machines are in the same subnet.

4. Since now we have a session open on a compromised host within the target network, we can use the `autoroute` command to add a route to the subnet of the network that both the target hosts are part of. 
```
run autoroute -s 10.2.27.0/20
```

5. Setting up the routing will allow us to communicate with victim machine 2 through victim machine 1.

6. We can now use the TCP portscan module to run a scan on the previously inaccessible host in the subnet. This will allow us to discover the open ports on the host. 
```
use auxiliary/scanner/portscan/tcp
```

7. In order to identify the service version of the open port in victim 2, we need to perform a `nmap` scan, however this route is only accessible through `msfconsole`, we cannot interact with the second host outside `msfconsole`. 

8. Since we cannot perform a `nmap` scan on victim 2 directly yet, we need to setup port forwarding. 
```
portfwd add -l 1234 -p <remote-port> -r <host-IP>
```
- In this case, we are forwarding the remote port in our 2nd target machine to our local port 1234 
- This will allow us to perform a service version scan.

9. Now that the remote port has been forwarded successfully, we can perform a `nmap` scan outside `MSF`. 
```
nmap -sV -p 1234 localhost
```
- We are scanning port 1234 since we have forwarded the remote port to our local port 1234 on the local host.

10. The only reason we've performed port forwarding is so that we can scan and enumerate the vulnerable services in victim 2.

11. In our case, we've discovered a vulnerable bad blue service running. We'll set the payload to a `bind_tcp` payload, since reverse TCP connection is not possible.
```
set payload windows/meterpreter/bind_tcp
```
- Set `RHOST` to the victim 2 IP.
- We don't need to change the `RPORT` since we've added a route in `msfconsole`.

12. After exploiting, we can change the session name to victim 2.
```
sessions -n victim-2 -i 2
```

