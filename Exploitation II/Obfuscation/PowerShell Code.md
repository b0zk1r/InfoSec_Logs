### PowerShell code obfuscation

+ Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE.

+ As a penetration tester, you will find yourself working with PowerShell code frequently. Most AV solutions will immediately flag malicious PowerShell code, as a result, you must be able to obfuscate/encode your PowerShell code and scripts in order to avoid detection.
---
### What is Invoke-Obfuscation ?

+ Invoke-Obfuscation is an open source PowerShell v2.0+ compatible PowerShell command and script obfuscator.

GitHub Repo: https://github.com/danielbohannon/Invoke-Obfuscation

---
### How to use Invoke-Obfuscation ?

1. Git-Clone the repository.

2. First we need to install PowerShell. 
```
sudo apt-get install powershell -y
```

3. We can launch PowerShell in Linux using the `pwsh` command in the terminal. This will give us a PowerShell session in our machine. 

4. We'll now import the `Invoke-Obfuscation` PowerShell module.
```
Import-Module ./Invoke-Obfuscation.psd1
```

5. Now we'll run the module using the `Invoke-Obfuscation` command. 

6. We now need to create a reverse shell PowerShell script. To do this, we can use a PowerShell command from the `PayloadAllTheThings` Github repository.

7. Open a text editor and paste the copied code in there. Make the following changes in the code:
	+ Remove the line `powershell -nop -c` from the beginning of the code.
	+ Remove the quotation marks from both the ends of the code.
	+ Change the attacker IP to our machine IP address. 
- Save the file with the `.ps1` extension.  

8. Switch back to the terminal running `Invoke-Obfuscation`and configure the options.
	+ Set the `ScriptPath` variable to the path of the PowerShell script we created. `SET SCRIPTPATH <path-to-file>

9. There are multiple ways to obfuscate the code, but in our case we'll be using `AST` to obfuscate the PowerShell AST nodes. 

10. The obfuscated code will be displayed in the terminal itself. We need to copy the code and save it as a `.ps1` file using our text editor. 

11. We'll now setup a `nc` listener on the port mentioned in the `ps` code and also send the code to our target machine.

12. Once the target executes the `ps` script, we should obtain reverse shell access to the target system. 

